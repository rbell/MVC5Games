@model Games.Models.RockPaperScissorsGamePlayModel
@{
    ViewBag.Title = "GamePlay";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Play Rock, Paper, Scissors!</h2>
<input id="sessionId" type="hidden" value="@Model.SessionId" />
<input id="playerId" type="hidden" value="@Model.PlayerId" />
<div>
    <button id="btnRock" type="button" class="btn" data-loading-text="Rock">Rock</button>
    <button id="btnPaper" type="button" class="btn" data-loading-text="Paper">Paper</button>
    <button id="btnScissors" type="button" class="btn" data-loading-text="Scissors">Scissors</button>
    <span id="status" class="label label-success"></span>
</div>
<div>
    <h3>Players</h3>
    <ul id="players">
        @for (int i = 0; i < Model.Players.Count; i++)
        {
                <li>@Model.Players[i].Name&nbsp;<span id="playerSelection@(i)" class="label label-success"></span></li>
        }
    </ul>
</div>


@section scripts{
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.0-rc1.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">
        $(function () {

            if (@Model.PlayerCount <= 1) {
                $('#btnRock').button('loading');
                $('#btnPaper').button('loading');
                $('#btnScissors').button('loading');
                $('#status').text("Waiting for another player to join.");
            }
            else {
                $('#status').text('Make your selection now.');
            }

            var rockPaperScissors = $.connection.rockPaperScissorsHub;
            rockPaperScissors.client.playerJoined = function (player, playerCount) {
                if (playerCount > 1) {
                    var encodedName = $('<div />').text(player.Name).html();
                    $('#players').append('<li>' + encodedName + '&nbsp;<span id="playerSelection1" class="label label-success"></span></li>');
                    $('#btnRock').button('reset');
                    $('#btnPaper').button('reset');
                    $('#btnScissors').button('reset');
                    $('#status').text('Make your selection now.');
                }
            }

            rockPaperScissors.client.winner = function (player1, player2) {
                $('#playerSelection0').text('Played ' + player1.Selection);
                $('#playerSelection1').text('Played ' + player2.Selection);
                var winnerName = player1.isWinner ? player1.Name : player2.Name;
                $('#status').text('Winner is ' + winnerName);
            }

            function playerSelectedValue(v) {
                rockPaperScissors.server.playerSelectedValue('@Model.SessionId','@Model.PlayerId',v);
                $('#btnRock').button('loading');
                $('#btnPaper').button('loading');
                $('#btnScissors').button('loading');
                $('#status').text("Waiting for other players to make selection.");
            }

            $.connection.hub.start().done(function(){
                rockPaperScissors.server.join('@Model.SessionId');
                $('#btnRock').click(function () {
                    playerSelectedValue('rock');
                });
                $('#btnPaper').click(function () {
                    playerSelectedValue('paper');
                });
                $('#btnScissors').click(function () {
                    playerSelectedValue('scissors');
                });
            });
        });
    </script>
}

